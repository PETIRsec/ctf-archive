const puppeteer = require('puppeteer');
const {
    setTimeout
} = require('node:timers/promises');
const JWTHelper = require('./helpers/JWTHelper');


const browser_options = {
    headless: true,
    args: [
        '--no-sandbox',
        '--disable-background-networking',
        '--disable-default-apps',
        '--disable-extensions',
        '--disable-gpu',
        '--disable-sync',
        '--disable-translate',
        '--hide-scrollbars',
        '--metrics-recording-only',
        '--mute-audio',
        '--no-first-run',
        '--safebrowsing-disable-auto-update',
        '--js-flags=--noexpose_wasm,--jitless'
    ]
};

const visitPost = async (section) => {
    try {
        const browser = await puppeteer.launch(browser_options);
        let context = await browser.createBrowserContext();
        let page = await context.newPage();

        let token = await JWTHelper.sign({
            username: 'beluga',
            user_role: 'administrator'
        });
        await page.setCookie({
            name: "session",
            'value': token,
            domain: "127.0.0.1:31337"
        });

        await page.goto(`http://127.0.0.1:31337/${section}`, {
            waitUntil: 'networkidle2',
            timeout: 5000
        });
        await setTimeout(3000);
        await browser.close();
    } catch (e) {
        console.log(e);
    }
};

module.exports = {
    visitPost
};